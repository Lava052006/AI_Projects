# Express Backend Design Document

## Overview

This design outlines a TypeScript-based Express server with Prisma ORM integration for PostgreSQL database operations and Ollama AI integration for feedback generation. The system provides a foundational web API with health monitoring, user management, feedback collection capabilities, and AI-powered feedback generation. The architecture emphasizes type safety, clean separation of concerns, and scalable database operations with local AI integration.

## Architecture

The system follows a layered architecture pattern:

```
┌─────────────────────────────────────┐
│           HTTP Layer                │
│    (Express Routes & Middleware)    │
├─────────────────────────────────────┤
│          Service Layer              │
│     (Business Logic & Validation)   │
├─────────────────────────────────────┤
│         Data Access Layer           │
│        (Prisma Client)              │
├─────────────────────────────────────┤
│         Database Layer              │
│         (PostgreSQL)                │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         External AI Layer           │
│      (Ollama + Mistral Model)       │
└─────────────────────────────────────┘
```

### Key Architectural Decisions

1. **TypeScript First**: All code written in TypeScript for compile-time type safety
2. **Prisma ORM**: Type-safe database operations with automatic migration support
3. **Express.js**: Lightweight, flexible web framework for HTTP handling
4. **Layered Architecture**: Clear separation between HTTP, business logic, and data layers
5. **Environment Configuration**: Database connection and server settings via environment variables
6. **Local AI Integration**: Direct integration with Ollama for AI-powered feedback generation
7. **Minimal Dependencies**: Simple command execution for AI integration without complex libraries

## Components and Interfaces

### Core Components

#### 1. Express Server (`src/index.ts`)
- Main application entry point
- Middleware configuration (CORS, JSON parsing)
- Route registration
- Server startup and error handling

#### 2. Prisma Client (`src/lib/prisma.ts`)
- Database client initialization
- Connection management
- Type-safe query interface

#### 3. Route Handlers (`src/routes/`)
- Health check endpoint
- AI feedback generation endpoint
- User management endpoints (future)
- Feedback management endpoints (future)

#### 5. AI Service (`src/services/ollama.ts`)
- Ollama command execution
- Prompt processing and validation
- Response parsing and error handling

#### 4. Database Schema (`prisma/schema.prisma`)
- PostgreSQL datasource configuration
- User and Feedback model definitions
- Relationship mappings

### Interface Definitions

```typescript
// User Model Interface (generated by Prisma)
interface User {
  id: string;
  name: string;
  role: Role;
  createdAt: Date;
  feedback: Feedback[];
}

// Feedback Model Interface (generated by Prisma)
interface Feedback {
  id: string;
  content: string;
  confidence: number;
  userId: string;
  user: User;
  createdAt: Date;
}

// Role Enum
enum Role {
  STUDENT = "STUDENT",
  TEACHER = "TEACHER"
}

// AI Request/Response Interfaces
interface AIFeedbackRequest {
  prompt: string;
}

interface AIFeedbackResponse {
  feedback: string;
}

interface AIErrorResponse {
  error: string;
  message: string;
}
```

## Data Models

### User Model
- **Purpose**: Represents system users with role-based access
- **Primary Key**: `id` (cuid)
- **Fields**:
  - `name`: User's display name (required)
  - `role`: STUDENT or TEACHER enum value
  - `createdAt`: Automatic timestamp
- **Relationships**: One-to-many with Feedback

### Feedback Model
- **Purpose**: Stores user feedback with confidence metrics
- **Primary Key**: `id` (cuid)
- **Fields**:
  - `content`: Feedback text content (required)
  - `confidence`: Numerical confidence score (float)
  - `userId`: Foreign key to User
  - `createdAt`: Automatic timestamp
- **Relationships**: Many-to-one with User

### Database Schema Structure

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  TEACHER
}

model User {
  id        String     @id @default(cuid())
  name      String
  role      Role
  createdAt DateTime   @default(now())
  feedback  Feedback[]
}

model Feedback {
  id         String   @id @default(cuid())
  content    String
  confidence Float
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
}
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property Reflection

After analyzing all acceptance criteria, several properties can be consolidated to eliminate redundancy:

- User and Feedback model properties for cuid generation can be combined into a single "Model ID Generation" property
- User and Feedback model properties for required fields can be combined into respective validation properties
- Timestamp properties for both models can be combined into a single "Automatic Timestamp" property

### Core Properties

**Property 1: JSON Request Parsing**
*For any* valid JSON payload sent to the server, the request body should be correctly parsed and accessible in route handlers
**Validates: Requirements 2.2**

**Property 2: Model ID Generation**
*For any* created User or Feedback record, the generated ID should follow valid cuid format and be unique
**Validates: Requirements 6.1, 7.1**

**Property 3: User Model Validation**
*For any* User creation attempt, records with valid names and roles should succeed, while records missing required fields should be rejected
**Validates: Requirements 6.2, 6.3**

**Property 4: Feedback Model Validation**
*For any* Feedback creation attempt, records with valid content, confidence scores, and user references should succeed, while records missing required fields should be rejected
**Validates: Requirements 7.2, 7.3, 7.4**

**Property 5: Automatic Timestamp Generation**
*For any* created User or Feedback record, the createdAt field should be automatically set to a valid timestamp at creation time
**Validates: Requirements 6.4, 7.5**

**Property 6: User-Feedback Relationship**
*For any* User with associated Feedback records, querying the user should return all related feedback, and each feedback should correctly reference the user
**Validates: Requirements 8.5**

**Property 7: AI Prompt Validation**
*For any* POST request to /api/ai/feedback, requests with valid prompt fields should be accepted, while requests with missing or empty prompts should return HTTP 400
**Validates: Requirements 9.2, 9.3**

**Property 8: AI Response Format**
*For any* successful Ollama execution, the response should be formatted as JSON with a feedback field containing the AI output
**Validates: Requirements 9.5**

**Property 9: AI Error Handling**
*For any* AI service failure, the server should return HTTP 500 with meaningful error messages without crashing
**Validates: Requirements 10.1, 10.2, 10.3**

## Error Handling

### Database Error Handling
- **Connection Failures**: Graceful handling of database connection issues with appropriate error messages
- **Constraint Violations**: Proper error responses for foreign key and unique constraint violations
- **Invalid Data Types**: Validation errors for incorrect data types (e.g., non-float confidence scores)

### HTTP Error Handling
- **Malformed JSON**: Return 400 Bad Request for invalid JSON payloads
- **Missing Required Fields**: Return 400 Bad Request with descriptive error messages
- **Database Errors**: Return 500 Internal Server Error for unexpected database issues
- **Port Binding Errors**: Graceful shutdown with error logging if port 4000 is unavailable

### AI Service Error Handling
- **Missing Prompt**: Return 400 Bad Request when prompt field is missing or empty
- **Ollama Execution Failures**: Return 500 Internal Server Error with descriptive error messages
- **Command Timeout**: Handle long-running AI operations with appropriate timeouts
- **Invalid AI Responses**: Handle malformed or empty responses from Ollama gracefully

### Validation Error Handling
- **Role Validation**: Reject invalid role values with clear error messages
- **Required Field Validation**: Ensure all required fields are present before database operations
- **Data Type Validation**: Validate confidence scores are valid numbers

## Testing Strategy

### Dual Testing Approach

The system will use both unit testing and property-based testing to ensure comprehensive coverage:

- **Unit tests** verify specific examples, edge cases, and error conditions
- **Property tests** verify universal properties that should hold across all inputs
- Together they provide comprehensive coverage: unit tests catch concrete bugs, property tests verify general correctness

### Unit Testing

Unit tests will cover:
- Health endpoint returns correct response format
- Server starts on correct port (4000)
- CORS headers are present in responses
- Database connection initialization
- Role enum contains correct values
- AI endpoint accessibility and basic functionality
- Specific error conditions and edge cases

### Property-Based Testing

Property-based testing will use **fast-check** library for JavaScript/TypeScript with a minimum of 100 iterations per test.

Each property-based test will be tagged with comments explicitly referencing the correctness property:
- Format: `**Feature: express-backend, Property {number}: {property_text}**`

Property-based tests will cover:
- JSON parsing across various valid payloads
- Model ID generation consistency and uniqueness
- User model validation across different input combinations
- Feedback model validation across different input combinations
- Timestamp generation consistency
- User-Feedback relationship integrity
- AI prompt validation across various input combinations
- AI response formatting consistency
- AI error handling across different failure scenarios

### Integration Testing

Integration tests will verify:
- End-to-end API functionality
- Database schema migrations
- Prisma client integration with Express routes
- Error handling across the full stack

### Test Organization

- Unit tests: Co-located with source files using `.test.ts` suffix
- Property-based tests: Separate test files in `__tests__/properties/` directory
- Integration tests: `__tests__/integration/` directory
- Test utilities and fixtures: `__tests__/utils/` directory